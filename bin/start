#!/usr/bin/env bash

set -e

echo "Starting application..."

# Clean up any existing PID files
rm -f tmp/pids/server.pid

# Kill any existing processes on port 3000
echo "Checking for existing processes on port 3000..."
if lsof -ti:3000 > /dev/null 2>&1; then
  echo "Found existing process on port 3000, killing it..."
  lsof -ti:3000 | xargs kill -9 || true
  sleep 2
fi

# Run database migrations
echo "Running database migrations..."
bundle exec rails db:migrate

# Start the Rails server
echo "Starting Rails server..."
exec bundle exec puma -C config/puma.rb
